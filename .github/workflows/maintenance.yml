name: orchestrator

on:
  workflow_dispatch:
    inputs:
      debug:
        description: "Run in debug mode"
        required: false
        default: "false"
  schedule:
    - cron: "0 2 * * *"
  repository_dispatch:
    types: [prcyber_event]

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    env:
      EVENT_PAYLOAD: ${{ toJson(github.event.client_payload) }}
      DEBUG_MODE: ${{ github.event.inputs.debug || 'false' }}
    steps:
      - name: ðŸ‘° Install dependencies
        run: |
          apt-get update -y
          apt-get install -y git python3 python3-pip curl jq
          pip3 install codex-cli

      - name: ðŸ“… Checkout orchestrator repo
        uses: actions/checkout@v3

      - name: ðŸ§‘â€ðŸ« Analyze event with codex
        id: codex
        run: |
          echo "ðŸ” Invoking codex CLI to determine target agentsâ€¦"
          echo "$EVENT_PAYLOAD" | codex analyze \
            --output-format=json \
            > /tmp/codex_output.json
          echo "Codex output:"
          cat /tmp/codex_output.json
          AGENT_LIST=$(jq -r '.agents[]?' /tmp/codex_output.json | paste -sd "," -)
          echo "agent_list=$AGENT_LIST" >> $GITHUB_OUTPUT

      - name: ðŸ—š Dispatch to target agents
        if: steps.codex.outputs.agent_list != ''
        run: |
          IFS=',' read -ra AGENTS <<< "${{ steps.codex.outputs.agent_list }}"
          for AGENT in "${AGENTS[@]}"; do
            echo "ðŸš€ Dispatching event to $AGENT"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/PR-CYBR/${AGENT}/dispatches \
              -d "{\"event_type\": \"agent_task\", \"client_payload\": $EVENT_PAYLOAD}"
          done
        env:
          EVENT_PAYLOAD: ${{ env.EVENT_PAYLOAD }}

      - name: ðŸ’¤ No agents needed
        if: steps.codex.outputs.agent_list == ''
        run: |
          echo "ðŸ˜´ Codex did not suggest any agents. Nothing to dispatch."
