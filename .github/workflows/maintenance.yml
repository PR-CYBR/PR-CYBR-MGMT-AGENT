name: orchestrator

on:
  # Manual trigger via Actions UI
  workflow_dispatch:
    inputs:
      debug:
        description: "Run in debug mode"
        required: false
        default: "false"
  # Scheduled run (e.g., nightly health check)
  schedule:
    - cron: "0 2 * * *"  # 02:00 UTC daily
  # Central trigger from org-level webhook
  repository_dispatch:
    types: [prcyber_event]

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    env:
      EVENT_PAYLOAD: ${{ toJson(github.event.client_payload) }}
      DEBUG_MODE: ${{ github.event.inputs.debug || 'false' }}
    steps:
      - name: ðŸ“‹ Checkout orchestrator repo
        uses: actions/checkout@v3

      - name: ðŸ§  Install dependencies
        run: |
          apt-get update -y
          apt-get install -y git python3 python3-pip curl jq

      - name: ðŸ¤– Analyze event with codex
        id: codex
        run: |
          echo "ðŸ” Invoking codex CLI to determine target agentsâ€¦"
          # Use the local codex script from the scripts directory
          chmod +x ./scripts/codex
          echo "$EVENT_PAYLOAD" | python3 ./scripts/codex analyze \
            --output-format=json \
            > /tmp/codex_output.json
          echo "Codex output:"
          cat /tmp/codex_output.json
          # Extract agent list into a GitHub Actions output
          AGENT_LIST=$(jq -r '.agents[]?' /tmp/codex_output.json | paste -sd "," -)
          echo "agent_list=$AGENT_LIST" >> $GITHUB_OUTPUT

      - name: ðŸª„ Dispatch to target agents
        if: steps.codex.outputs.agent_list != ''
        run: |
          IFS=',' read -ra AGENTS <<< "${{ steps.codex.outputs.agent_list }}"
          for AGENT in "${AGENTS[@]}"; do
            echo "ðŸš€ Dispatching event to $AGENT"
            # Use GitHub API to trigger a repository_dispatch event on the agent repository.
            # Requires a repository token stored in secrets.GH_TOKEN with repo:public_repo scope.
            curl -X POST \
              -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/PR-CYBR/${AGENT}/dispatches \
              -d "{\"event_type\": \"agent_task\", \"client_payload\": $EVENT_PAYLOAD}"
          done
        env:
          EVENT_PAYLOAD: ${{ env.EVENT_PAYLOAD }}

      - name: ðŸ›Œ No agents needed
        if: steps.codex.outputs.agent_list == ''
        run: |
          echo "ðŸ˜´ Codex did not suggest any agents. Nothing to dispatch."
